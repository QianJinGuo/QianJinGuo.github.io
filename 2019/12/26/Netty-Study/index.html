<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Netty,">





  <link rel="alternate" href="/scheme" title="架构师成长之旅" type="application/atom+xml">






<meta name="description" content="业界哪些流行的开源框架用Netty作为底层通信框架 Dubbo： 阿里开源的高性能RPC框架 RocketMQ： 阿里出品的高性能消息队列 Spark： 炙手可热的大数据处理引擎，底层使用Netty Elasticsearch： 分布式多用户的全文搜索引擎 Apache Cassandra：开源分布式搜索数据库 Flink:分布式高性能高可用的流处理框架 Netty-SocketIO的java服务">
<meta name="keywords" content="Netty">
<meta property="og:type" content="article">
<meta property="og:title" content="Netty Study">
<meta property="og:url" content="https://jinguo.tech/2019/12/26/Netty-Study/index.html">
<meta property="og:site_name" content="架构师成长之旅">
<meta property="og:description" content="业界哪些流行的开源框架用Netty作为底层通信框架 Dubbo： 阿里开源的高性能RPC框架 RocketMQ： 阿里出品的高性能消息队列 Spark： 炙手可热的大数据处理引擎，底层使用Netty Elasticsearch： 分布式多用户的全文搜索引擎 Apache Cassandra：开源分布式搜索数据库 Flink:分布式高性能高可用的流处理框架 Netty-SocketIO的java服务">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/005Vjva3gy1g2khv8xo9uj30xv0hnjwl.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/005Vjva3gy1g2jjx06me9j30wi0jj0z8.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/005Vjva3gy1g2kf4qvkn2j30wm0m4ti7.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/005Vjva3gy1g2q5th3hz7j30fu0cyq43.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/005Vjva3gy1g2q87lnpb3j30om0dm42s.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/005Vjva3gy1g2qektcmgnj30w70gyjxt.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/005Vjva3gy1g2qems6khbj30w70glaex.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/005Vjva3gy1g2q8bxb9z6j30h109mgn0.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/005Vjva3gy1g2kg7oiieaj30tm0ds43k.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/005Vjva3gy1g2kgfjm05gj314u0qg1kx.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/005Vjva3gy1g2kgxvgph7j31880o7nf4.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/005Vjva3gy1g2qilnmzwij30se0htwqp.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/005Vjva3gy1g2qipchj94j30s20chth5.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/005Vjva3gy1g2qkgzymnyj30gq0bht9k.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/005Vjva3gy1g2qj3z3tr0j30er089dfu.jpg">
<meta property="og:updated_time" content="2019-12-26T08:50:59.570Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Netty Study">
<meta name="twitter:description" content="业界哪些流行的开源框架用Netty作为底层通信框架 Dubbo： 阿里开源的高性能RPC框架 RocketMQ： 阿里出品的高性能消息队列 Spark： 炙手可热的大数据处理引擎，底层使用Netty Elasticsearch： 分布式多用户的全文搜索引擎 Apache Cassandra：开源分布式搜索数据库 Flink:分布式高性能高可用的流处理框架 Netty-SocketIO的java服务">
<meta name="twitter:image" content="http://ww1.sinaimg.cn/large/005Vjva3gy1g2khv8xo9uj30xv0hnjwl.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://jinguo.tech/2019/12/26/Netty-Study/">





  <title>Netty Study | 架构师成长之旅</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">架构师成长之旅</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">刻意练习，从新手到领域大牛</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jinguo.tech/2019/12/26/Netty-Study/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qian JinGuo">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="架构师成长之旅">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Netty Study</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-26T15:59:12+08:00">
                2019-12-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/12/26/Netty-Study/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/12/26/Netty-Study/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  29
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="业界哪些流行的开源框架用Netty作为底层通信框架"><a href="#业界哪些流行的开源框架用Netty作为底层通信框架" class="headerlink" title="业界哪些流行的开源框架用Netty作为底层通信框架"></a>业界哪些流行的开源框架用Netty作为底层通信框架</h2><ul>
<li>Dubbo： 阿里开源的高性能RPC框架</li>
<li>RocketMQ： 阿里出品的高性能消息队列</li>
<li>Spark： 炙手可热的大数据处理引擎，底层使用Netty</li>
<li>Elasticsearch： 分布式多用户的全文搜索引擎</li>
<li>Apache Cassandra：开源分布式搜索数据库</li>
<li>Flink:分布式高性能高可用的流处理框架</li>
<li>Netty-SocketIO的java服务端实现</li>
<li>Spring5：使用Netty作为http协议框架</li>
<li>Play：简单易用的http服务器</li>
<li>Grpc:google开源的高性能rpc通信框架</li>
<li>Infinispan：针对缓存的高并发键值对数据存储</li>
<li>HornetQ：支持集群和多种协议，可嵌入、高性能的异步消息系统</li>
<li>Vert.x轻量级高性能能JVM应用平台<br>-<br><a href="https://netty.io/wiki/adopters.html" target="_blank" rel="noopener">完整的参考列表</a></li>
</ul>
<h2 id="业界有哪些公司在使用Netty"><a href="#业界有哪些公司在使用Netty" class="headerlink" title="业界有哪些公司在使用Netty"></a>业界有哪些公司在使用Netty</h2><p><strong>在大型企业中</strong>有：Apple、Twitter的Finagle、Facebook的Nifty、Google、Square、Instagram<br><br><strong>在初创企业中</strong>有：做http长连接的<strong>Firebase</strong>、支持各种各样消息推送通知的<strong>Urban Airship</strong><br><br><br> 当然，Netty也从这些项目中<strong>受益</strong>。通过实现 FTP、 SMTP、 HTTP 和 WebSocket 以及其他的基于二进制和基于文本的协议， Netty 扩展了它的应用范围及灵活性。</p>
<h2 id="Netty是什么"><a href="#Netty是什么" class="headerlink" title="Netty是什么"></a>Netty是什么</h2><ol>
<li><strong>异步</strong>和<strong>事件驱动</strong>的高性能网络通信框架。</li>
<li><strong>特点:</strong>它可以以任意的顺序响应在任意的时间点产生的事件，可以实现最高级别的可伸缩性。</li>
<li><strong>目的:</strong>用于快速开发高性能服务端和客户端</li>
<li><strong>封装:</strong>JDK底层BIO和NIO模型，提供高度可用的API,满足各类业务场景，其中ChannelHandler的热插拔机制解放了业务逻辑之外的细节问题，让业务逻辑的添加和删除非常容易</li>
<li>自带编解码器解决拆包粘包问题，用户只关心业务逻辑</li>
<li>精心设计的reactor线程模型支持高并发海量连接</li>
<li>自带各种协议栈如http、websocket，处理任何一种通信协议都几乎不用亲自动手</li>
<li><strong>架构方法和设计原则：</strong>每个小点都和它的技术性内容一样重要，穷其精妙。如关注点分离–业务和网络逻辑解耦，模块化和可复用性，可测试性。</li>
</ol>
<h2 id="Netty的特性总结"><a href="#Netty的特性总结" class="headerlink" title="Netty的特性总结"></a>Netty的特性总结</h2><p><img src="http://ww1.sinaimg.cn/large/005Vjva3gy1g2khv8xo9uj30xv0hnjwl.jpg" alt></p>
<br>

<h2 id="Socket-amp-Netty"><a href="#Socket-amp-Netty" class="headerlink" title="Socket &amp; Netty"></a>Socket &amp; Netty</h2><p><img src="http://ww1.sinaimg.cn/large/005Vjva3gy1g2jjx06me9j30wi0jj0z8.jpg" alt="Socket &amp; Netty"></p>
<h2 id="Netty基本组件"><a href="#Netty基本组件" class="headerlink" title="Netty基本组件"></a>Netty基本组件</h2><p><img src="http://ww1.sinaimg.cn/large/005Vjva3gy1g2kf4qvkn2j30wm0m4ti7.jpg" alt></p>
<ul>
<li>NioEventLoop -&gt;Thread</li>
<li>Channel -&gt;Socket<br>NioSocketChannel implements Channel<br>Chennel is a nexus to a network socket or a component which is capable operations such as read,write,connect,and bind</li>
<li>ByteBuf -&gt;IO Bytes<br>readBytes()、writeBytes() and so on</li>
<li>Pipline -&gt;Logic Chain 逻辑链 </li>
<li>ChannelHandler -&gt;Logic处理块</li>
</ul>
<h2 id="Netty核心组件"><a href="#Netty核心组件" class="headerlink" title="Netty核心组件"></a>Netty核心组件</h2><h3 id="1-Channel-Socket"><a href="#1-Channel-Socket" class="headerlink" title="1. Channel-Socket"></a>1. Channel-Socket</h3><p>Channel是通讯的载体，其基本构造是Socket<br>是对网络底层读写和连接原语言的抽象  </p>
<h3 id="2-EventLoop-控制流、多线程处理、并发"><a href="#2-EventLoop-控制流、多线程处理、并发" class="headerlink" title="2. EventLoop-控制流、多线程处理、并发"></a>2. EventLoop-控制流、多线程处理、并发</h3><p>定义了 Netty 的核心抽象， 用于处理连接的生命周期中所发生的事件</p>
<p>###注: Channel、 EventLoop、 Thread 以及EventLoopGroup 之间的关系<br><img src="http://ww1.sinaimg.cn/large/005Vjva3gy1g2q5th3hz7j30fu0cyq43.jpg" alt></p>
<h5 id="A-一个-EventLoopGroup-包含一个或者多个-EventLoop；"><a href="#A-一个-EventLoopGroup-包含一个或者多个-EventLoop；" class="headerlink" title="A. 一个 EventLoopGroup 包含一个或者多个 EventLoop；"></a>A. 一个 EventLoopGroup 包含一个或者多个 EventLoop；</h5><h5 id="B-一个-EventLoop-在它的生命周期内只和一个-Thread-绑定"><a href="#B-一个-EventLoop-在它的生命周期内只和一个-Thread-绑定" class="headerlink" title="B. 一个 EventLoop 在它的生命周期内只和一个 Thread 绑定"></a>B. 一个 EventLoop 在它的生命周期内只和一个 Thread 绑定</h5><h5 id="C-所有由-EventLoop-处理的-I-O-事件都将在它专有的-Thread-上被处理；"><a href="#C-所有由-EventLoop-处理的-I-O-事件都将在它专有的-Thread-上被处理；" class="headerlink" title="C. 所有由 EventLoop 处理的 I/O 事件都将在它专有的 Thread 上被处理；"></a>C. 所有由 EventLoop 处理的 I/O 事件都将在它专有的 Thread 上被处理；</h5><h5 id="D-一个-Channel-在它的生命周期内只注册于一个-EventLoop；"><a href="#D-一个-Channel-在它的生命周期内只注册于一个-EventLoop；" class="headerlink" title="D. 一个 Channel 在它的生命周期内只注册于一个 EventLoop；"></a>D. 一个 Channel 在它的生命周期内只注册于一个 EventLoop；</h5><h5 id="E-一个-EventLoop-可能会被分配给一个或多个-Channel"><a href="#E-一个-EventLoop-可能会被分配给一个或多个-Channel" class="headerlink" title="E. 一个 EventLoop 可能会被分配给一个或多个 Channel"></a>E. 一个 EventLoop 可能会被分配给一个或多个 Channel</h5><h5 id="F-一个给定-Channel-的-I-O-操作都是由相同的-Thread-执行的，-实际上消除了对于同步的需要。"><a href="#F-一个给定-Channel-的-I-O-操作都是由相同的-Thread-执行的，-实际上消除了对于同步的需要。" class="headerlink" title="F. 一个给定 Channel 的 I/O 操作都是由相同的 Thread 执行的， 实际上消除了对于同步的需要。"></a>F. 一个给定 Channel 的 I/O 操作都是由相同的 Thread 执行的， 实际上消除了对于同步的需要。</h5><p><img src="http://ww1.sinaimg.cn/large/005Vjva3gy1g2q87lnpb3j30om0dm42s.jpg" alt></p>
<h3 id="3-ChannelFuture-异步通知"><a href="#3-ChannelFuture-异步通知" class="headerlink" title="3. ChannelFuture-异步通知"></a>3. ChannelFuture-异步通知</h3><p>Netty 中所有的 I/O 操作都是异步的,用于在之后的某个时间点确定其结果的方法</p>
<h3 id="4-ChannelHandler和ChannelPipeline"><a href="#4-ChannelHandler和ChannelPipeline" class="headerlink" title="4. ChannelHandler和ChannelPipeline"></a>4. ChannelHandler和ChannelPipeline</h3><p>ChannelHandler负责Channel中的逻辑处理<br>其旨在简化应用程序处理逻辑的开发过程<br>充当了所有处理入站和出站数据的应用程序逻辑的容器<br>ChannelHandler子接口：<br>ChannelInboundHandler——处理入站数据以及各种状态变化<br>ChannelOutboundHandler——处理出站数据并且允许拦截所有的操作<br>ChannelInboundHandler的方法:<br><img src="https://ws1.sinaimg.cn/large/005Vjva3gy1g2qektcmgnj30w70gyjxt.jpg" alt><br>ChannelOutboundHandler的方法:<br><img src="https://ws1.sinaimg.cn/large/005Vjva3gy1g2qems6khbj30w70glaex.jpg" alt></p>
<p>ChannelPipeline 提供了 ChannelHandler链的容器<br>定义了用于在该链上传播入站和出站事件流的API</p>
<h3 id="5-ByteBuf-Netty的数据容器"><a href="#5-ByteBuf-Netty的数据容器" class="headerlink" title="5. ByteBuf-Netty的数据容器"></a>5. ByteBuf-Netty的数据容器</h3><p>Java NIO提供了ByteBuffer作为它的字节容器<br>Netty的ByteBuffer替代品是ByteBuf  </p>
<h5 id="A-它可以被用户自定义的缓冲区类型扩展，通过内置的复合缓冲区类型实现了透明的零拷贝；"><a href="#A-它可以被用户自定义的缓冲区类型扩展，通过内置的复合缓冲区类型实现了透明的零拷贝；" class="headerlink" title="A. 它可以被用户自定义的缓冲区类型扩展，通过内置的复合缓冲区类型实现了透明的零拷贝；"></a>A. 它可以被用户自定义的缓冲区类型扩展，通过内置的复合缓冲区类型实现了透明的零拷贝；</h5><h5 id="B-容量可以按需增长（类似于-JDK-的-StringBuilder）"><a href="#B-容量可以按需增长（类似于-JDK-的-StringBuilder）" class="headerlink" title="B.容量可以按需增长（类似于 JDK 的 StringBuilder）"></a>B.容量可以按需增长（类似于 JDK 的 StringBuilder）</h5><h5 id="C-读和写使用了不同的索引"><a href="#C-读和写使用了不同的索引" class="headerlink" title="C.读和写使用了不同的索引"></a>C.读和写使用了不同的索引</h5><h5 id="D-支持方法的链式调用"><a href="#D-支持方法的链式调用" class="headerlink" title="D.支持方法的链式调用"></a>D.支持方法的链式调用</h5><h5 id="E-支持引用计数"><a href="#E-支持引用计数" class="headerlink" title="E.支持引用计数"></a>E.支持引用计数</h5><h5 id="F-支持池化"><a href="#F-支持池化" class="headerlink" title="F.支持池化"></a>F.支持池化</h5><h3 id="6-Bootstap-引导客户端和无连接协议"><a href="#6-Bootstap-引导客户端和无连接协议" class="headerlink" title="6. Bootstap-引导客户端和无连接协议"></a>6. Bootstap-引导客户端和无连接协议</h3><p>Bootstrap类负责为客户端和使用无连接协议的应用程序创建 Channel<br><img src="http://ww1.sinaimg.cn/large/005Vjva3gy1g2q8bxb9z6j30h109mgn0.jpg" alt></p>
<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><p>使用EmbeddedChannel 测试 ChannelHandler  </p>
<ol>
<li>测试入站消息  </li>
<li>测试出站消息  </li>
<li>测试异常处理  </li>
</ol>
<h2 id="编解码器"><a href="#编解码器" class="headerlink" title="编解码器"></a>编解码器</h2><ul>
<li>解码器<br>将字节解码为消息<br>将一种消息类型解码为另一种</li>
<li>编码器<br>将消息编码为字节<br>将消息编码为消息</li>
</ul>
<h2 id="Netty服务端启动"><a href="#Netty服务端启动" class="headerlink" title="Netty服务端启动"></a>Netty服务端启动</h2><ol>
<li>创建服务端Channel</li>
<li>初始化服务端Channel</li>
<li>注册Selector</li>
<li>端口绑定，实现对本地端口的接听</li>
</ol>
<h2 id="预置的ChannelHandler和编解码器"><a href="#预置的ChannelHandler和编解码器" class="headerlink" title="预置的ChannelHandler和编解码器"></a>预置的ChannelHandler和编解码器</h2><ol>
<li>通过 SSL/TLS 保护 Netty 应用程序</li>
<li>ChannelHandler处理 HTTP 和 HTTPS协议</li>
<li>支持WebSocket</li>
<li>ChannelHandler检测空闲连接以及超时</li>
<li>FileRegion,通过支持零拷贝的文件传输的Channel来发送的文件区域</li>
<li>使用JDK、JBOSS Marshalling、Protocol Buffers序列化数据</li>
<li>使用UDP广播事件</li>
</ol>
<h3 id="创建服务端Channel"><a href="#创建服务端Channel" class="headerlink" title="创建服务端Channel"></a>创建服务端Channel</h3><p><strong>bind()[用户代码入口] -&gt;initAndRegister()[初始化并注册] -&gt;newChannel()[创建服务端channel]</strong><br><img src="http://ww1.sinaimg.cn/large/005Vjva3gy1g2kg7oiieaj30tm0ds43k.jpg" alt></p>
<p><img src="http://ww1.sinaimg.cn/large/005Vjva3gy1g2kgfjm05gj314u0qg1kx.jpg" alt></p>
<p><img src="http://ww1.sinaimg.cn/large/005Vjva3gy1g2kgxvgph7j31880o7nf4.jpg" alt></p>
<h2 id="如何使用Netty进行RPC服务器的开发"><a href="#如何使用Netty进行RPC服务器的开发" class="headerlink" title="如何使用Netty进行RPC服务器的开发?"></a>如何使用Netty进行RPC服务器的开发?</h2><ol>
<li>定义RPC请求消息、应答消息结构，里面要包括RPC的接口定义模块、包括远程调用的类名、方法名称、参数结构、参数值等信息。    </li>
<li>服务端初始化的时候通过容器加载RPC接口定义和RPC接口实现类对象的映射关系，然后等待客户端发起调用请求。</li>
<li>客户端发起的RPC消息里面包含，远程调用的类名、方法名称、参数结构、参数值等信息，通过网络，以字节流的方式送给RPC服务端，RPC服务端接收到字节流的请求之后，去对应的容器里面，查找客户端接口映射的具体实现对象。</li>
<li>RPC服务端找到实现对象的参数信息，通过反射机制创建该对象的实例，并返回调用处理结果，最后封装成RPC应答消息通知到客户端。</li>
<li>客户端通过网络，收到字节流形式的RPC应答消息，进行拆包、解析之后，显示远程调用结果。<br><img src="https://ws1.sinaimg.cn/large/005Vjva3gy1g2qilnmzwij30se0htwqp.jpg" alt><br><strong>客户端并发发起RPC调用请求，然后RPC服务端使用Netty连接器，分派出N个NIO连接线程，这个时候Netty连接器的任务结束。然后NIO连接线程是统一放到Netty NIO处理线程池进行管理，这个线程池里面会对具体的RPC请求连接进行消息编码、消息解码、消息处理等等一系列操作。最后进行消息处理（Handler）的时候，处于性能考虑，这里的设计是，直接把复杂的消息处理过程，丢给专门的RPC业务处理线程池集中处理，然后Handler对应的NIO线程就立即返回、不会阻塞。这个时候RPC调用结束，客户端会异步等待服务端消息的处理结果，通过消息回调机制实现。</strong><br>Netty对于RPC消息的解码、编码、处理对应的模块和流程，具体如下图所示：<br><img src="https://ws1.sinaimg.cn/large/005Vjva3gy1g2qipchj94j30s20chth5.jpg" alt><br><strong>客户端、服务端对RPC消息编码、解码、处理调用的模块以及调用顺序。    Netty把这样一个一个的处理器串在一起，形成一个责任链，统一进行调用。</strong></li>
</ol>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="Netty疑问"><a href="#Netty疑问" class="headerlink" title="Netty疑问"></a>Netty疑问</h3><ol>
<li>Netty是什么？<br>Netty是一个基于JAVA NIO类库的异步通信框架，它的架构特点是：异步非阻塞、基于事件驱动、高性能、高可靠性和高可定制性。</li>
<li>使用Netty能够做什么？<br>①开发异步、非阻塞的TCP网络应用程序；<br>②开发异步、非阻塞的UDP网络应用程序；<br>③开发异步文件传输应用程序；<br>④开发异步HTTP服务端和客户端应用程序；<br>⑤提供对多种编解码框架的集成；<br>⑥提供形式多样的编解码基础类库；<br>⑦基于职责链模式的Pipeline-Handler机制；<br>⑧所有的IO操作都是异步的；<br>⑨IP黑白名单控制，性能统计；<br>⑩基于链路空闲事件检测的心跳检测；</li>
<li>Netty在哪些行业得到了应用<br><strong>①互联网行业：</strong>随着网站规模的不断扩大，系统并发访问量也越来越高，传统基于Tomcat等Web容器的垂直架构已经无法满足需求，需要拆分应用进行服务化，以提高开发和维护效率。从组网情况看，垂直的架构拆分之后，系统采用分布式部署，各个节点之间需要远程服务调用，高性能的RPC框架必不可少，Netty作为异步高性能的通信框架，往往作为基础通信组件被这些RPC框架使用。<br>典型的应用有：阿里分布式服务框架Dubbo的RPC框架使用Dubbo协议进行节点间通信，Dubbo协议默认使用Netty作为基础通信组件，用于实现各进程节点之间的内部通信。其中，服务提供者和服务消费者之间，服务提供者、服务消费者和性能统计节点之间使用Netty进行异步/同步通信。除了Dubbo之外，淘宝的消息中间件RocketMQ的消息生产者和消息消费者之间，也采用Netty进行高性能、异步通信。<br>除了阿里系和淘宝系之外，很多其它的大型互联网公司或者电商内部也已经大量使用Netty构建高性能、分布式的网络服务器。<br><strong>②大数据领域：</strong>经典的Hadoop的高性能通信和序列化组件Avro的RPC框架，默认采用Netty进行跨节点通信，它的Netty Service基于Netty框架二次封装实现。大数据计算往往采用多个计算节点和一个/N个汇总节点进行分布式部署，各节点之间存在海量的数据交换。由于Netty的综合性能是目前各个成熟NIO框架中最高的，因此，往往会被选中用作大数据各节点间的通信。<br><strong>③企业软件：</strong>企业和IT集成需要ESB，Netty对多协议支持、私有协议定制的简洁性和高性能是ESB RPC框架的首选通信组件。事实上，很多企业总线厂商会选择Netty作为基础通信组件，用于企业的IT集成。<br><strong>④通信行业：</strong>Netty的异步高性能、高可靠性和高成熟度的优点，使它在通信行业得到了大量的应用。<br><strong>⑤游戏行业：</strong>无论是手游服务端、还是大型的网络游戏，Java语言得到了越来越广泛的应用。Netty作为高性能的基础通信组件，它本身提供了TCP/UDP和HTTP协议栈，非常方便定制和开发私有协议栈。账号登陆服务器、地图服务器之间可以方便的通过Netty进行高性能的通信。  </li>
<li>使用传统的Socket开发挺简单的，我为什么要切换到NIO进行编程呢？<br>传统的同步阻塞IO通信存在如下几个问题：<br><strong>①线程模型存在致命缺陷：</strong>一连接一线程的模型导致服务端无法承受大量客户端的并发连接；<br><strong>②性能差：</strong>频繁的线程上下文切换导致CPU利用效率不高；<br><strong>③可靠性差：</strong>由于所有的IO操作都是同步的，所以业务线程只要进行IO操作，也会存在被同步阻塞的风险，这会导致系统的可靠性差，依赖外部组件的处理能力和网络的情况。<br><strong>采用非阻塞IO（NIO）之后，同步阻塞IO的三个缺陷都将迎刃而解：</strong><br>①Nio采用Reactor模式<em>，一个Reactor线程聚合一个多路复用器Selector，它可以同时注册、监听和轮询成百上千个Channel，一个IO线程可以同时并发处理N个客户端连接，线程模型优化为1：N（N &lt; 进程可用的最大句柄数）或者 M : N (M通常为CPU核数 + 1， N &lt; 进程可用的最大句柄数)；<br>②由于IO线程总数有限，不会存在频繁的IO线程之间上下文切换和竞争，CPU利用率高；<br>③所有的IO操作都是异步的，即使业务线程直接进行IO操作，也不会被同步阻塞，系统不再依赖外部的网络环境和外部应用程序的处理性能。<br>*</em>由于切换到NIO编程之后可以为系统带来巨大的可靠性、性能提升，所以，目前采用NIO进行通信已经逐渐成为主流。**</li>
<li>为什么不直接基于JDK的NIO类库编程呢？<br>即便抛开代码和NIO类库复杂性不谈，一个高性能、高可靠性的NIO服务端开发和维护成本都是非常高的，开发者需要具有丰富的NIO编程经验和网络维护经验，很多时候甚至需要通过抓包来定位问题。也许开发出一套NIO程序需要1个月，但是它的稳定很可能需要1年甚至更长的时间，这也就是为什么我不建议直接使用JDK NIO类库进行通信开发的一个重要原因。</li>
<li>为什么要选择Netty框架？<br>Netty是业界最流行的NIO框架之一，它的健壮性、功能、性能、可定制性和可扩展性在同类框架中都是首屈一指的，它已经得到成百上千的商用项目验证，例如Hadoop的RPC框架Avro使用Netty作为通信框架。很多其它业界主流的RPC和分布式服务框架，也使用Netty来构建高性能的异步通信能力。<br>Netty的优点总结如下：<br>①API使用简单，开发门槛低；<br>②功能强大，预置了多种编解码功能，支持多种主流协议；<br>③定制能力强，可以通过ChannelHandler对通信框架进行灵活的扩展；<br>④性能高，通过与其它业界主流的NIO框架对比，Netty的综合性能最优；<br>⑤成熟、稳定，Netty修复了已经发现的所有JDK NIO BUG，业务开发人员不需要再为NIO的BUG而烦恼；<br>⑥社区活跃，版本迭代周期短，发现的BUG可以被及时修复，同时，更多的新功能会被加入；<br>⑦经历了大规模的商业应用考验，质量得到验证。在互联网、大数据、网络游戏、企业应用、电信软件等众多行业得到成功商用，证明了它完全满足不同行业的商用标准。</li>
</ol>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="1-基于Netty的客户端和服务端的简单通信"><a href="#1-基于Netty的客户端和服务端的简单通信" class="headerlink" title="1. 基于Netty的客户端和服务端的简单通信"></a>1. 基于Netty的客户端和服务端的简单通信</h3><h5 id="要点："><a href="#要点：" class="headerlink" title="要点："></a>要点：</h5><p>①为初始化客户端， 创建了一个 Bootstrap 实例<br>②为进行事件处理分配了一个 NioEventLoopGroup 实例， 其中事件处理包括创建新的连接以及处理入站和出站数据；<br>③为服务器连接创建了一个 InetSocketAddress 实例；<br>④当连接被建立时，一个 EchoClientHandler 实例会被安装到（该 Channel 的）ChannelPipeline 中；<br>⑤在一切都设置完成后，调用 Bootstrap.connect()方法连接到远程节点；<br><img src="https://ws1.sinaimg.cn/large/005Vjva3gy1g2qkgzymnyj30gq0bht9k.jpg" alt></p>
<h3 id="EchoServerHandler"><a href="#EchoServerHandler" class="headerlink" title="EchoServerHandler"></a>EchoServerHandler</h3><h5 id="channelRead-—对于每个传入的消息都要调用；"><a href="#channelRead-—对于每个传入的消息都要调用；" class="headerlink" title="channelRead()—对于每个传入的消息都要调用；"></a>channelRead()—对于每个传入的消息都要调用；</h5><h5 id="channelReadComplete-—通知ChannelInboundHandler最后一次对channelRead-的调用是当前批量读取中的最后一条消息；"><a href="#channelReadComplete-—通知ChannelInboundHandler最后一次对channelRead-的调用是当前批量读取中的最后一条消息；" class="headerlink" title="channelReadComplete()—通知ChannelInboundHandler最后一次对channelRead()的调用是当前批量读取中的最后一条消息；"></a>channelReadComplete()—通知ChannelInboundHandler最后一次对channelRead()的调用是当前批量读取中的最后一条消息；</h5><h5 id="exceptionCaught-—在读取操作期间，有异常抛出时会调用。"><a href="#exceptionCaught-—在读取操作期间，有异常抛出时会调用。" class="headerlink" title="exceptionCaught()—在读取操作期间，有异常抛出时会调用。"></a>exceptionCaught()—在读取操作期间，有异常抛出时会调用。</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//标示一个ChannelHandler可以被多个 Channel 安全地共享</span></span><br><span class="line">		<span class="meta">@Sharable</span></span><br><span class="line">		<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line">		    <span class="meta">@Override</span></span><br><span class="line">		    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;</span><br><span class="line">		        ByteBuf in = (ByteBuf) msg;</span><br><span class="line">		        <span class="comment">//将消息记录到控制台</span></span><br><span class="line">		        System.out.println(</span><br><span class="line">		                <span class="string">"Server received: "</span> + in.toString(CharsetUtil.UTF_8));</span><br><span class="line">		        <span class="comment">//将接收到的消息写给发送者，而不冲刷出站消息</span></span><br><span class="line">		        ctx.write(in);</span><br><span class="line">		    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    @Override</span><br><span class="line">    public void channelReadComplete(ChannelHandlerContext ctx)</span><br><span class="line">            throws Exception &#123;</span><br><span class="line">        //将未决消息冲刷到远程节点，并且关闭该 Channel</span><br><span class="line">        ctx.writeAndFlush(Unpooled.EMPTY_BUFFER)</span><br><span class="line">                .addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void exceptionCaught(ChannelHandlerContext ctx,</span><br><span class="line">        Throwable cause) &#123;</span><br><span class="line">        //打印异常栈跟踪</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        //关闭该Channel</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="EchoServer"><a href="#EchoServer" class="headerlink" title="EchoServer"></a>EchoServer</h3><h5 id="绑定到服务器将在其上监听并接受传入连接请求的端口；"><a href="#绑定到服务器将在其上监听并接受传入连接请求的端口；" class="headerlink" title="绑定到服务器将在其上监听并接受传入连接请求的端口；"></a>绑定到服务器将在其上监听并接受传入连接请求的端口；</h5><h5 id="配置-Channel，以将有关的入站消息通知给-EchoServerHandler-实例"><a href="#配置-Channel，以将有关的入站消息通知给-EchoServerHandler-实例" class="headerlink" title="配置 Channel，以将有关的入站消息通知给 EchoServerHandler 实例"></a>配置 Channel，以将有关的入站消息通知给 EchoServerHandler 实例</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">public class EchoServer &#123;</span><br><span class="line">	private final int port;</span><br><span class="line">    public EchoServer(int port) &#123;</span><br><span class="line">        this.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args)</span><br><span class="line">        throws Exception &#123;</span><br><span class="line">        if (args.length != 1) &#123;</span><br><span class="line">            System.err.println(&quot;Usage: &quot; + EchoServer.class.getSimpleName() +</span><br><span class="line">                &quot; &lt;port&gt;&quot;</span><br><span class="line">            );</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        //设置端口值（如果端口参数的格式不正确，则抛出一个NumberFormatException）</span><br><span class="line">        int port = Integer.parseInt(args[0]);</span><br><span class="line">        //调用服务器的 start()方法</span><br><span class="line">        new EchoServer(port).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void start() throws Exception &#123;</span><br><span class="line">        final EchoServerHandler serverHandler = new EchoServerHandler();</span><br><span class="line">        //(1) 创建EventLoopGroup</span><br><span class="line">        EventLoopGroup group = new NioEventLoopGroup();</span><br><span class="line">        try &#123;</span><br><span class="line">            //(2) 创建ServerBootstrap</span><br><span class="line">            ServerBootstrap b = new ServerBootstrap();</span><br><span class="line">            b.group(group)</span><br><span class="line">                //(3) 指定所使用的 NIO 传输 Channel</span><br><span class="line">                .channel(NioServerSocketChannel.class)</span><br><span class="line">                //(4) 使用指定的端口设置套接字地址</span><br><span class="line">                .localAddress(new InetSocketAddress(port))</span><br><span class="line">                //(5) 添加一个EchoServerHandler到于Channel的 ChannelPipeline</span><br><span class="line">                .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void initChannel(SocketChannel ch) throws Exception &#123;</span><br><span class="line">                        //EchoServerHandler 被标注为@Shareable，所以我们可以总是使用同样的实例</span><br><span class="line">                        //这里对于所有的客户端连接来说，都会使用同一个 EchoServerHandler，因为其被标注为									 @Sharable，</span><br><span class="line">                        //这将在后面的章节中讲到。</span><br><span class="line">                        ch.pipeline().addLast(serverHandler);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            //(6) 异步地绑定服务器；调用 sync()方法阻塞等待直到绑定完成</span><br><span class="line">            ChannelFuture f = b.bind().sync();</span><br><span class="line">            System.out.println(EchoServer.class.getName() +</span><br><span class="line">                &quot; started and listening for connections on &quot; + f.channel().localAddress());</span><br><span class="line">            //(7) 获取 Channel 的CloseFuture，并且阻塞当前线程直到它完成</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            //(8) 关闭 EventLoopGroup，释放所有的资源</span><br><span class="line">            group.shutdownGracefully().sync();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通过-ChannelHandler-实现客户端逻辑"><a href="#通过-ChannelHandler-实现客户端逻辑" class="headerlink" title="通过 ChannelHandler 实现客户端逻辑"></a>通过 ChannelHandler 实现客户端逻辑</h3><h5 id="channelActive-——在到服务器的连接已经建立之后将被调用；"><a href="#channelActive-——在到服务器的连接已经建立之后将被调用；" class="headerlink" title="channelActive()——在到服务器的连接已经建立之后将被调用；"></a>channelActive()——在到服务器的连接已经建立之后将被调用；</h5><h5 id="channelRead0-——当服务器接收到一条消息时被调用"><a href="#channelRead0-——当服务器接收到一条消息时被调用" class="headerlink" title="channelRead0()——当服务器接收到一条消息时被调用"></a>channelRead0()——当服务器接收到一条消息时被调用</h5><h5 id="exceptionCaught-——在处理过程中引发异常时被调用。"><a href="#exceptionCaught-——在处理过程中引发异常时被调用。" class="headerlink" title="exceptionCaught()——在处理过程中引发异常时被调用。"></a>exceptionCaught()——在处理过程中引发异常时被调用。</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Sharable</span></span><br><span class="line">	<span class="comment">//标记该类的实例可以被多个 Channel 共享</span></span><br><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoClientHandler</span></span></span><br><span class="line"><span class="class">	    <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">ByteBuf</span>&gt; </span>&#123;</span><br><span class="line">	    <span class="meta">@Override</span></span><br><span class="line">	    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">	        <span class="comment">//当被通知 Channel是活跃的时候，发送一条消息</span></span><br><span class="line">	        ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="string">"Netty rocks!"</span>,</span><br><span class="line">	                CharsetUtil.UTF_8));</span><br><span class="line">	    &#125;</span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//记录已接收消息的转储</span></span><br><span class="line">        System.out.println(</span><br><span class="line">                <span class="string">"Client received: "</span> + in.toString(CharsetUtil.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//在发生异常时，记录错误并关闭Channel</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">        Throwable cause)</span> </span>&#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="引导客户端"><a href="#引导客户端" class="headerlink" title="引导客户端"></a>引导客户端</h3><h5 id="客户端是使用主机和端口参数来连接远程地址，也就是Echo-服务器的地址，而不是绑定到一个一直被监听的端口"><a href="#客户端是使用主机和端口参数来连接远程地址，也就是Echo-服务器的地址，而不是绑定到一个一直被监听的端口" class="headerlink" title="客户端是使用主机和端口参数来连接远程地址，也就是Echo 服务器的地址，而不是绑定到一个一直被监听的端口"></a>客户端是使用主机和端口参数来连接远程地址，也就是Echo 服务器的地址，而不是绑定到一个一直被监听的端口</h5><p>​        public class EchoClient {<br>​            private final String host;<br>​            private final int port;<br>​            public EchoClient(String host, int port) {<br>​                this.host = host;<br>​                this.port = port;<br>​        </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void start()</span><br><span class="line">        throws Exception &#123;</span><br><span class="line">        EventLoopGroup group = new NioEventLoopGroup();</span><br><span class="line">        try &#123;</span><br><span class="line">            //创建 Bootstrap</span><br><span class="line">            Bootstrap b = new Bootstrap();</span><br><span class="line">            //指定 EventLoopGroup 以处理客户端事件；需要适用于 NIO 的实现</span><br><span class="line">            b.group(group)</span><br><span class="line">                //适用于 NIO 传输的Channel 类型</span><br><span class="line">                .channel(NioSocketChannel.class)</span><br><span class="line">                //设置服务器的InetSocketAddress</span><br><span class="line">                .remoteAddress(new InetSocketAddress(host, port))</span><br><span class="line">                //在创建Channel时，向 ChannelPipeline中添加一个 EchoClientHandler实例</span><br><span class="line">                .handler(new ChannelInitializer&lt;SocketChannel&gt;()    &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void initChannel(SocketChannel ch)</span><br><span class="line">                        throws Exception &#123;</span><br><span class="line">                        ch.pipeline().addLast(</span><br><span class="line">                             new EchoClientHandler());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            //连接到远程节点，阻塞等待直到连接完成</span><br><span class="line">            ChannelFuture f = b.connect().sync();</span><br><span class="line">            //阻塞，直到Channel 关闭</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            //关闭线程池并且释放所有的资源</span><br><span class="line">            group.shutdownGracefully().sync();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args)</span><br><span class="line">            throws Exception &#123;</span><br><span class="line">        if (args.length != 2) &#123;</span><br><span class="line">            System.err.println(&quot;Usage: &quot; + EchoClient.class.getSimpleName() +</span><br><span class="line">                    &quot; &lt;host&gt; &lt;port&gt;&quot;</span><br><span class="line">            );</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final String host = args[0];</span><br><span class="line">        final int port = Integer.parseInt(args[1]);</span><br><span class="line">        new EchoClient(host, port).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-基于Zookeeper、Netty和Spring的轻量级的分布式RPC框架"><a href="#2-基于Zookeeper、Netty和Spring的轻量级的分布式RPC框架" class="headerlink" title="2. 基于Zookeeper、Netty和Spring的轻量级的分布式RPC框架"></a>2. 基于Zookeeper、Netty和Spring的轻量级的分布式RPC框架</h3><h5 id="简易RPC有如下特性："><a href="#简易RPC有如下特性：" class="headerlink" title="简易RPC有如下特性："></a>简易RPC有如下特性：</h5><ul>
<li>服务异步调用的支持，回调函数callback的支持</li>
<li>客户端使用长连接（在多次调用共享连接）</li>
<li>服务端异步多线程处理RPC请求</li>
<li>服务发布与订阅：服务端使用Zookeeper注册服务地址，客户端从Zookeeper获取可用的服务地址。</li>
<li>通信：使用Netty作为通信框架</li>
<li>Spring：使用Spring配置服务，加载Bean，扫描注解</li>
<li>动态代理：客户端使用代理模式透明化服务调用</li>
<li>消息编解码：使用Protostuff序列化和反序列化消息</li>
</ul>
<h5 id="RPC介绍"><a href="#RPC介绍" class="headerlink" title="RPC介绍"></a>RPC介绍</h5><p>RPC，即 Remote Procedure Call（远程过程调用），调用远程计算机上的服务，就像调用本地服务一样。RPC可以很好的解耦系统，如WebService就是一种基于Http协议的RPC。<br><img src="https://ws1.sinaimg.cn/large/005Vjva3gy1g2qj3z3tr0j30er089dfu.jpg" alt></p>
<ul>
<li>服务端发布服务</li>
</ul>
<h5 id="服务注解："><a href="#服务注解：" class="headerlink" title="服务注解："></a>服务注解：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Component</span><br><span class="line">public @interface RpcService &#123;</span><br><span class="line">    Class&lt;?&gt; value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="一个服务接口："><a href="#一个服务接口：" class="headerlink" title="一个服务接口："></a>一个服务接口：</h5><p>​        public interface HelloService {<br>​        </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    String hello(String name);</span><br><span class="line"></span><br><span class="line">    String hello(Person person);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="一个服务实现：使用注解标注："><a href="#一个服务实现：使用注解标注：" class="headerlink" title="一个服务实现：使用注解标注："></a>一个服务实现：使用注解标注：</h5><p>​        @RpcService(HelloService.class)<br>​        public class HelloServiceImpl implements HelloService {<br>​        </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    @Override</span><br><span class="line">    public String hello(String name) &#123;</span><br><span class="line">        return &quot;Hello! &quot; + name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String hello(Person person) &#123;</span><br><span class="line">        return &quot;Hello! &quot; + person.getFirstName() + &quot; &quot; + person.getLastName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="服务在启动的时候扫描得到所有的服务接口及其实现："><a href="#服务在启动的时候扫描得到所有的服务接口及其实现：" class="headerlink" title="服务在启动的时候扫描得到所有的服务接口及其实现："></a>服务在启动的时候扫描得到所有的服务接口及其实现：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public void setApplicationContext(ApplicationContext ctx) throws BeansException &#123;</span><br><span class="line">        Map&lt;String, Object&gt; serviceBeanMap = ctx.getBeansWithAnnotation(RpcService.class);</span><br><span class="line">        if (MapUtils.isNotEmpty(serviceBeanMap)) &#123;</span><br><span class="line">            for (Object serviceBean : serviceBeanMap.values()) &#123;</span><br><span class="line">                String interfaceName = serviceBean.getClass().getAnnotation(RpcService.class).value().getName();</span><br><span class="line">                handlerMap.put(interfaceName, serviceBean);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="在Zookeeper集群上注册服务地址："><a href="#在Zookeeper集群上注册服务地址：" class="headerlink" title="在Zookeeper集群上注册服务地址："></a>在Zookeeper集群上注册服务地址：</h5><p>​        public class ServiceRegistry {<br>​        </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">    private static final Logger LOGGER = LoggerFactory.getLogger(ServiceRegistry.class);</span><br><span class="line"></span><br><span class="line">    private CountDownLatch latch = new CountDownLatch(1);</span><br><span class="line"></span><br><span class="line">    private String registryAddress;</span><br><span class="line"></span><br><span class="line">    public ServiceRegistry(String registryAddress) &#123;</span><br><span class="line">        this.registryAddress = registryAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void register(String data) &#123;</span><br><span class="line">        if (data != null) &#123;</span><br><span class="line">            ZooKeeper zk = connectServer();</span><br><span class="line">            if (zk != null) &#123;</span><br><span class="line">                AddRootNode(zk); // Add root node if not exist</span><br><span class="line">                createNode(zk, data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private ZooKeeper connectServer() &#123;</span><br><span class="line">        ZooKeeper zk = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            zk = new ZooKeeper(registryAddress, Constant.ZK_SESSION_TIMEOUT, new Watcher() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void process(WatchedEvent event) &#123;</span><br><span class="line">                    if (event.getState() == Event.KeeperState.SyncConnected) &#123;</span><br><span class="line">                        latch.countDown();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            latch.await();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            LOGGER.error(&quot;&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (InterruptedException ex)&#123;</span><br><span class="line">            LOGGER.error(&quot;&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        return zk;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void AddRootNode(ZooKeeper zk)&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Stat s = zk.exists(Constant.ZK_REGISTRY_PATH, false);</span><br><span class="line">            if (s == null) &#123;</span><br><span class="line">                zk.create(Constant.ZK_REGISTRY_PATH, new byte[0], ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (KeeperException e) &#123;</span><br><span class="line">            LOGGER.error(e.toString());</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            LOGGER.error(e.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void createNode(ZooKeeper zk, String data) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            byte[] bytes = data.getBytes();</span><br><span class="line">            String path = zk.create(Constant.ZK_DATA_PATH, bytes, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><span class="line">            LOGGER.debug(&quot;create zookeeper node (&#123;&#125; =&gt; &#123;&#125;)&quot;, path, data);</span><br><span class="line">        &#125; catch (KeeperException e) &#123;</span><br><span class="line">            LOGGER.error(&quot;&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (InterruptedException ex)&#123;</span><br><span class="line">            LOGGER.error(&quot;&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>客户端调用服务<h5 id="使用代理模式调用服务："><a href="#使用代理模式调用服务：" class="headerlink" title="使用代理模式调用服务："></a>使用代理模式调用服务：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public class RpcProxy &#123;</span><br><span class="line">    private String serverAddress;</span><br><span class="line">    private ServiceDiscovery serviceDiscovery;</span><br><span class="line"></span><br><span class="line">    public RpcProxy(String serverAddress) &#123;</span><br><span class="line">        this.serverAddress = serverAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public RpcProxy(ServiceDiscovery serviceDiscovery) &#123;</span><br><span class="line">        this.serviceDiscovery = serviceDiscovery;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public &lt;T&gt; T create(Class&lt;?&gt; interfaceClass) &#123;</span><br><span class="line">        return (T) Proxy.newProxyInstance(</span><br><span class="line">                interfaceClass.getClassLoader(),</span><br><span class="line">                new Class&lt;?&gt;[]&#123;interfaceClass&#125;,</span><br><span class="line">                new InvocationHandler() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">                        RpcRequest request = new RpcRequest();</span><br><span class="line">                        request.setRequestId(UUID.randomUUID().toString());</span><br><span class="line">                        request.setClassName(method.getDeclaringClass().getName());</span><br><span class="line">                        request.setMethodName(method.getName());</span><br><span class="line">                        request.setParameterTypes(method.getParameterTypes());</span><br><span class="line">                        request.setParameters(args);</span><br><span class="line"></span><br><span class="line">                        if (serviceDiscovery != null) &#123;</span><br><span class="line">                            serverAddress = serviceDiscovery.discover();</span><br><span class="line">                        &#125;</span><br><span class="line">                        if(serverAddress != null)&#123;</span><br><span class="line">                            String[] array = serverAddress.split(&quot;:&quot;);</span><br><span class="line">                            String host = array[0];</span><br><span class="line">                            int port = Integer.parseInt(array[1]);</span><br><span class="line"></span><br><span class="line">                            RpcClient client = new RpcClient(host, port);</span><br><span class="line">                            RpcResponse response = client.send(request);</span><br><span class="line"></span><br><span class="line">                            if (response.isError()) &#123;</span><br><span class="line">                                throw new RuntimeException(&quot;Response error.&quot;,new Throwable(response.getError()));</span><br><span class="line">                            &#125; else &#123;</span><br><span class="line">                                return response.getResult();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        else&#123;</span><br><span class="line">                            throw new RuntimeException(&quot;No server address found!&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="从Zookeeper上获取服务地址："><a href="#从Zookeeper上获取服务地址：" class="headerlink" title="从Zookeeper上获取服务地址："></a>从Zookeeper上获取服务地址：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">public class ServiceDiscovery &#123;</span><br><span class="line">    private static final Logger LOGGER = LoggerFactory.getLogger(ServiceDiscovery.class);</span><br><span class="line"></span><br><span class="line">    private CountDownLatch latch = new CountDownLatch(1);</span><br><span class="line"></span><br><span class="line">    private volatile List&lt;String&gt; dataList = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    private String registryAddress;</span><br><span class="line"></span><br><span class="line">    public ServiceDiscovery(String registryAddress) &#123;</span><br><span class="line">        this.registryAddress = registryAddress;</span><br><span class="line">        ZooKeeper zk = connectServer();</span><br><span class="line">        if (zk != null) &#123;</span><br><span class="line">            watchNode(zk);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String discover() &#123;</span><br><span class="line">        String data = null;</span><br><span class="line">        int size = dataList.size();</span><br><span class="line">        if (size &gt; 0) &#123;</span><br><span class="line">            if (size == 1) &#123;</span><br><span class="line">                data = dataList.get(0);</span><br><span class="line">                LOGGER.debug(&quot;using only data: &#123;&#125;&quot;, data);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                data = dataList.get(ThreadLocalRandom.current().nextInt(size));</span><br><span class="line">                LOGGER.debug(&quot;using random data: &#123;&#125;&quot;, data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private ZooKeeper connectServer() &#123;</span><br><span class="line">        ZooKeeper zk = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            zk = new ZooKeeper(registryAddress, Constant.ZK_SESSION_TIMEOUT, new Watcher() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void process(WatchedEvent event) &#123;</span><br><span class="line">                    if (event.getState() == Event.KeeperState.SyncConnected) &#123;</span><br><span class="line">                        latch.countDown();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            latch.await();</span><br><span class="line">        &#125; catch (IOException | InterruptedException e) &#123;</span><br><span class="line">            LOGGER.error(&quot;&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">        return zk;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void watchNode(final ZooKeeper zk) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            List&lt;String&gt; nodeList = zk.getChildren(Constant.ZK_REGISTRY_PATH, new Watcher() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void process(WatchedEvent event) &#123;</span><br><span class="line">                    if (event.getType() == Event.EventType.NodeChildrenChanged) &#123;</span><br><span class="line">                        watchNode(zk);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            List&lt;String&gt; dataList = new ArrayList&lt;&gt;();</span><br><span class="line">            for (String node : nodeList) &#123;</span><br><span class="line">                byte[] bytes = zk.getData(Constant.ZK_REGISTRY_PATH + &quot;/&quot; + node, false, null);</span><br><span class="line">                dataList.add(new String(bytes));</span><br><span class="line">            &#125;</span><br><span class="line">            LOGGER.debug(&quot;node data: &#123;&#125;&quot;, dataList);</span><br><span class="line">            this.dataList = dataList;</span><br><span class="line">        &#125; catch (KeeperException | InterruptedException e) &#123;</span><br><span class="line">            LOGGER.error(&quot;&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>消息编码<h5 id="请求消息："><a href="#请求消息：" class="headerlink" title="请求消息："></a>请求消息：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">public class RpcRequest &#123;	</span><br><span class="line">    private String requestId;</span><br><span class="line">    private String className;</span><br><span class="line">    private String methodName;</span><br><span class="line">    private Class&lt;?&gt;[] parameterTypes;</span><br><span class="line">    private Object[] parameters;</span><br><span class="line"></span><br><span class="line">    public String getRequestId() &#123;</span><br><span class="line">        return requestId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setRequestId(String requestId) &#123;</span><br><span class="line">        this.requestId = requestId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getClassName() &#123;</span><br><span class="line">        return className;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setClassName(String className) &#123;</span><br><span class="line">        this.className = className;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getMethodName() &#123;</span><br><span class="line">        return methodName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setMethodName(String methodName) &#123;</span><br><span class="line">        this.methodName = methodName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Class&lt;?&gt;[] getParameterTypes() &#123;</span><br><span class="line">        return parameterTypes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setParameterTypes(Class&lt;?&gt;[] parameterTypes) &#123;</span><br><span class="line">        this.parameterTypes = parameterTypes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object[] getParameters() &#123;</span><br><span class="line">        return parameters;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setParameters(Object[] parameters) &#123;</span><br><span class="line">        this.parameters = parameters;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="响应消息："><a href="#响应消息：" class="headerlink" title="响应消息："></a>响应消息：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public class RpcResponse &#123;</span><br><span class="line">    private String requestId;</span><br><span class="line">    private String error;</span><br><span class="line">    private Object result;</span><br><span class="line"></span><br><span class="line">    public boolean isError() &#123;</span><br><span class="line">        return error != null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getRequestId() &#123;</span><br><span class="line">        return requestId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setRequestId(String requestId) &#123;</span><br><span class="line">        this.requestId = requestId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getError() &#123;</span><br><span class="line">        return error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setError(String error) &#123;</span><br><span class="line">        this.error = error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object getResult() &#123;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setResult(Object result) &#123;</span><br><span class="line">        this.result = result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="消息序列化和反序列化工具：（基于-Protostuff-实现）"><a href="#消息序列化和反序列化工具：（基于-Protostuff-实现）" class="headerlink" title="消息序列化和反序列化工具：（基于 Protostuff 实现）"></a>消息序列化和反序列化工具：（基于 Protostuff 实现）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">public class SerializationUtil &#123;</span><br><span class="line">    private static Map&lt;Class&lt;?&gt;, Schema&lt;?&gt;&gt; cachedSchema = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    private static Objenesis objenesis = new ObjenesisStd(true);</span><br><span class="line"></span><br><span class="line">    private SerializationUtil() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    private static &lt;T&gt; Schema&lt;T&gt; getSchema(Class&lt;T&gt; cls) &#123;</span><br><span class="line">        Schema&lt;T&gt; schema = (Schema&lt;T&gt;) cachedSchema.get(cls);</span><br><span class="line">        if (schema == null) &#123;</span><br><span class="line">            schema = RuntimeSchema.createFrom(cls);</span><br><span class="line">            if (schema != null) &#123;</span><br><span class="line">                cachedSchema.put(cls, schema);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return schema;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 序列化（对象 -&gt; 字节数组）</span><br><span class="line">     */</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public static &lt;T&gt; byte[] serialize(T obj) &#123;</span><br><span class="line">        Class&lt;T&gt; cls = (Class&lt;T&gt;) obj.getClass();</span><br><span class="line">        LinkedBuffer buffer = LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE);</span><br><span class="line">        try &#123;</span><br><span class="line">            Schema&lt;T&gt; schema = getSchema(cls);</span><br><span class="line">            return ProtostuffIOUtil.toByteArray(obj, schema, buffer);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new IllegalStateException(e.getMessage(), e);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            buffer.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 反序列化（字节数组 -&gt; 对象）</span><br><span class="line">     */</span><br><span class="line">    public static &lt;T&gt; T deserialize(byte[] data, Class&lt;T&gt; cls) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            T message = (T) objenesis.newInstance(cls);</span><br><span class="line">            Schema&lt;T&gt; schema = getSchema(cls);</span><br><span class="line">            ProtostuffIOUtil.mergeFrom(data, message, schema);</span><br><span class="line">            return message;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new IllegalStateException(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>性能改进</p>
<h5 id="服务端请求异步处理"><a href="#服务端请求异步处理" class="headerlink" title="服务端请求异步处理"></a>服务端请求异步处理</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx,<span class="keyword">final</span> RpcRequest request)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">	        RpcServer.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">	            <span class="meta">@Override</span></span><br><span class="line">	            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	                LOGGER.debug(<span class="string">"Receive request "</span> + request.getRequestId());</span><br><span class="line">	                RpcResponse response = <span class="keyword">new</span> RpcResponse();</span><br><span class="line">	                response.setRequestId(request.getRequestId());</span><br><span class="line">	                <span class="keyword">try</span> &#123;</span><br><span class="line">	                    Object result = handle(request);</span><br><span class="line">	                    response.setResult(result);</span><br><span class="line">	                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">	                    response.setError(t.toString());</span><br><span class="line">	                    LOGGER.error(<span class="string">"RPC Server handle request error"</span>,t);</span><br><span class="line">	                &#125;</span><br><span class="line"> ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE).addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</span><br><span class="line">	                    <span class="meta">@Override</span></span><br><span class="line">	                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture channelFuture)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">	                        LOGGER.debug(<span class="string">"Send response for request "</span> + request.getRequestId());</span><br><span class="line">	                    &#125;</span><br><span class="line">	                &#125;);</span><br><span class="line">	            &#125;</span><br><span class="line">	        &#125;);</span><br><span class="line">	    &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="服务端长连接的管理"><a href="#服务端长连接的管理" class="headerlink" title="服务端长连接的管理"></a>服务端长连接的管理</h5><p>客户端保持和服务进行<strong>长连接</strong>，不需要每次调用服务的时候进行连接，长连接的管理（通过Zookeeper获取有效的地址）。<br>通过监听Zookeeper服务节点值的变化，动态更新客户端和服务端保持的长连接。这个事情现在放在客户端在做，客户端保持了和所有可用服务的长连接，给客户端和服务端都造成了压力，需要解耦这个实现。</p>
<h5 id="客户端请求异步处理"><a href="#客户端请求异步处理" class="headerlink" title="客户端请求异步处理"></a>客户端请求异步处理</h5><p><strong>客户端请求异步处理的支持，不需要同步等待：发送一个异步请求，返回Future，通过Future的callback机制获取结果。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IAsyncObjectProxy client = rpcClient.createAsync(HelloService.class);</span><br><span class="line">RPCFuture helloFuture = client.call(&quot;hello&quot;, Integer.toString(i));</span><br><span class="line">String result = (String) helloFuture.get(3000, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure>


      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Netty/" rel="tag"># Netty</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/12/26/restart-blog/" rel="next" title="restart blog.md">
                <i class="fa fa-chevron-left"></i> restart blog.md
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/26/StormDRPC/" rel="prev" title="StormDRPC">
                StormDRPC <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/avatar.png" alt="Qian JinGuo">
            
              <p class="site-author-name" itemprop="name">Qian JinGuo</p>
              <p class="site-description motion-element" itemprop="description">从初学者开始，学习涵盖Java,Scala,Python,Go等核心编程语言，逐步掌握分布式、高并发的开发诀窍。习得算法，框架原理，工程化的开发流程。练代码修炼之道，提升知识软实力，项目开发实战。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/scheme" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:1263639596@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/QianJinGuo" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#业界哪些流行的开源框架用Netty作为底层通信框架"><span class="nav-number">1.</span> <span class="nav-text">业界哪些流行的开源框架用Netty作为底层通信框架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#业界有哪些公司在使用Netty"><span class="nav-number">2.</span> <span class="nav-text">业界有哪些公司在使用Netty</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Netty是什么"><span class="nav-number">3.</span> <span class="nav-text">Netty是什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Netty的特性总结"><span class="nav-number">4.</span> <span class="nav-text">Netty的特性总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Socket-amp-Netty"><span class="nav-number">5.</span> <span class="nav-text">Socket &amp; Netty</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Netty基本组件"><span class="nav-number">6.</span> <span class="nav-text">Netty基本组件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Netty核心组件"><span class="nav-number">7.</span> <span class="nav-text">Netty核心组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Channel-Socket"><span class="nav-number">7.1.</span> <span class="nav-text">1. Channel-Socket</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-EventLoop-控制流、多线程处理、并发"><span class="nav-number">7.2.</span> <span class="nav-text">2. EventLoop-控制流、多线程处理、并发</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#A-一个-EventLoopGroup-包含一个或者多个-EventLoop；"><span class="nav-number">7.2.0.1.</span> <span class="nav-text">A. 一个 EventLoopGroup 包含一个或者多个 EventLoop；</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#B-一个-EventLoop-在它的生命周期内只和一个-Thread-绑定"><span class="nav-number">7.2.0.2.</span> <span class="nav-text">B. 一个 EventLoop 在它的生命周期内只和一个 Thread 绑定</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#C-所有由-EventLoop-处理的-I-O-事件都将在它专有的-Thread-上被处理；"><span class="nav-number">7.2.0.3.</span> <span class="nav-text">C. 所有由 EventLoop 处理的 I/O 事件都将在它专有的 Thread 上被处理；</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#D-一个-Channel-在它的生命周期内只注册于一个-EventLoop；"><span class="nav-number">7.2.0.4.</span> <span class="nav-text">D. 一个 Channel 在它的生命周期内只注册于一个 EventLoop；</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#E-一个-EventLoop-可能会被分配给一个或多个-Channel"><span class="nav-number">7.2.0.5.</span> <span class="nav-text">E. 一个 EventLoop 可能会被分配给一个或多个 Channel</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#F-一个给定-Channel-的-I-O-操作都是由相同的-Thread-执行的，-实际上消除了对于同步的需要。"><span class="nav-number">7.2.0.6.</span> <span class="nav-text">F. 一个给定 Channel 的 I/O 操作都是由相同的 Thread 执行的， 实际上消除了对于同步的需要。</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-ChannelFuture-异步通知"><span class="nav-number">7.3.</span> <span class="nav-text">3. ChannelFuture-异步通知</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-ChannelHandler和ChannelPipeline"><span class="nav-number">7.4.</span> <span class="nav-text">4. ChannelHandler和ChannelPipeline</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-ByteBuf-Netty的数据容器"><span class="nav-number">7.5.</span> <span class="nav-text">5. ByteBuf-Netty的数据容器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#A-它可以被用户自定义的缓冲区类型扩展，通过内置的复合缓冲区类型实现了透明的零拷贝；"><span class="nav-number">7.5.0.1.</span> <span class="nav-text">A. 它可以被用户自定义的缓冲区类型扩展，通过内置的复合缓冲区类型实现了透明的零拷贝；</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#B-容量可以按需增长（类似于-JDK-的-StringBuilder）"><span class="nav-number">7.5.0.2.</span> <span class="nav-text">B.容量可以按需增长（类似于 JDK 的 StringBuilder）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#C-读和写使用了不同的索引"><span class="nav-number">7.5.0.3.</span> <span class="nav-text">C.读和写使用了不同的索引</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#D-支持方法的链式调用"><span class="nav-number">7.5.0.4.</span> <span class="nav-text">D.支持方法的链式调用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#E-支持引用计数"><span class="nav-number">7.5.0.5.</span> <span class="nav-text">E.支持引用计数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#F-支持池化"><span class="nav-number">7.5.0.6.</span> <span class="nav-text">F.支持池化</span></a></li></ol></li></ol><li class="nav-item nav-level-3"><a class="nav-link" href="#6-Bootstap-引导客户端和无连接协议"><span class="nav-number">7.6.</span> <span class="nav-text">6. Bootstap-引导客户端和无连接协议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#单元测试"><span class="nav-number">8.</span> <span class="nav-text">单元测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编解码器"><span class="nav-number">9.</span> <span class="nav-text">编解码器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Netty服务端启动"><span class="nav-number">10.</span> <span class="nav-text">Netty服务端启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#预置的ChannelHandler和编解码器"><span class="nav-number">11.</span> <span class="nav-text">预置的ChannelHandler和编解码器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建服务端Channel"><span class="nav-number">11.1.</span> <span class="nav-text">创建服务端Channel</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何使用Netty进行RPC服务器的开发"><span class="nav-number">12.</span> <span class="nav-text">如何使用Netty进行RPC服务器的开发?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附录"><span class="nav-number">13.</span> <span class="nav-text">附录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Netty疑问"><span class="nav-number">13.1.</span> <span class="nav-text">Netty疑问</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码"><span class="nav-number">14.</span> <span class="nav-text">代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-基于Netty的客户端和服务端的简单通信"><span class="nav-number">14.1.</span> <span class="nav-text">1. 基于Netty的客户端和服务端的简单通信</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#要点："><span class="nav-number">14.1.0.1.</span> <span class="nav-text">要点：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EchoServerHandler"><span class="nav-number">14.2.</span> <span class="nav-text">EchoServerHandler</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#channelRead-—对于每个传入的消息都要调用；"><span class="nav-number">14.2.0.1.</span> <span class="nav-text">channelRead()—对于每个传入的消息都要调用；</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#channelReadComplete-—通知ChannelInboundHandler最后一次对channelRead-的调用是当前批量读取中的最后一条消息；"><span class="nav-number">14.2.0.2.</span> <span class="nav-text">channelReadComplete()—通知ChannelInboundHandler最后一次对channelRead()的调用是当前批量读取中的最后一条消息；</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#exceptionCaught-—在读取操作期间，有异常抛出时会调用。"><span class="nav-number">14.2.0.3.</span> <span class="nav-text">exceptionCaught()—在读取操作期间，有异常抛出时会调用。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EchoServer"><span class="nav-number">14.3.</span> <span class="nav-text">EchoServer</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#绑定到服务器将在其上监听并接受传入连接请求的端口；"><span class="nav-number">14.3.0.1.</span> <span class="nav-text">绑定到服务器将在其上监听并接受传入连接请求的端口；</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#配置-Channel，以将有关的入站消息通知给-EchoServerHandler-实例"><span class="nav-number">14.3.0.2.</span> <span class="nav-text">配置 Channel，以将有关的入站消息通知给 EchoServerHandler 实例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过-ChannelHandler-实现客户端逻辑"><span class="nav-number">14.4.</span> <span class="nav-text">通过 ChannelHandler 实现客户端逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#channelActive-——在到服务器的连接已经建立之后将被调用；"><span class="nav-number">14.4.0.1.</span> <span class="nav-text">channelActive()——在到服务器的连接已经建立之后将被调用；</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#channelRead0-——当服务器接收到一条消息时被调用"><span class="nav-number">14.4.0.2.</span> <span class="nav-text">channelRead0()——当服务器接收到一条消息时被调用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#exceptionCaught-——在处理过程中引发异常时被调用。"><span class="nav-number">14.4.0.3.</span> <span class="nav-text">exceptionCaught()——在处理过程中引发异常时被调用。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#引导客户端"><span class="nav-number">14.5.</span> <span class="nav-text">引导客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#客户端是使用主机和端口参数来连接远程地址，也就是Echo-服务器的地址，而不是绑定到一个一直被监听的端口"><span class="nav-number">14.5.0.1.</span> <span class="nav-text">客户端是使用主机和端口参数来连接远程地址，也就是Echo 服务器的地址，而不是绑定到一个一直被监听的端口</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-基于Zookeeper、Netty和Spring的轻量级的分布式RPC框架"><span class="nav-number">14.6.</span> <span class="nav-text">2. 基于Zookeeper、Netty和Spring的轻量级的分布式RPC框架</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#简易RPC有如下特性："><span class="nav-number">14.6.0.1.</span> <span class="nav-text">简易RPC有如下特性：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RPC介绍"><span class="nav-number">14.6.0.2.</span> <span class="nav-text">RPC介绍</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#服务注解："><span class="nav-number">14.6.0.3.</span> <span class="nav-text">服务注解：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#一个服务接口："><span class="nav-number">14.6.0.4.</span> <span class="nav-text">一个服务接口：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#一个服务实现：使用注解标注："><span class="nav-number">14.6.0.5.</span> <span class="nav-text">一个服务实现：使用注解标注：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#服务在启动的时候扫描得到所有的服务接口及其实现："><span class="nav-number">14.6.0.6.</span> <span class="nav-text">服务在启动的时候扫描得到所有的服务接口及其实现：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在Zookeeper集群上注册服务地址："><span class="nav-number">14.6.0.7.</span> <span class="nav-text">在Zookeeper集群上注册服务地址：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用代理模式调用服务："><span class="nav-number">14.6.0.8.</span> <span class="nav-text">使用代理模式调用服务：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#从Zookeeper上获取服务地址："><span class="nav-number">14.6.0.9.</span> <span class="nav-text">从Zookeeper上获取服务地址：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#请求消息："><span class="nav-number">14.6.0.10.</span> <span class="nav-text">请求消息：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#响应消息："><span class="nav-number">14.6.0.11.</span> <span class="nav-text">响应消息：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#消息序列化和反序列化工具：（基于-Protostuff-实现）"><span class="nav-number">14.6.0.12.</span> <span class="nav-text">消息序列化和反序列化工具：（基于 Protostuff 实现）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#服务端请求异步处理"><span class="nav-number">14.6.0.13.</span> <span class="nav-text">服务端请求异步处理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#服务端长连接的管理"><span class="nav-number">14.6.0.14.</span> <span class="nav-text">服务端长连接的管理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#客户端请求异步处理"><span class="nav-number">14.6.0.15.</span> <span class="nav-text">客户端请求异步处理</span></a></li></ol></li></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
 
  <span class="author" itemprop="copyrightHolder">Qian JinGuo</span>
  <span><a href="https://jinguo.tech">苏ICP备19059185号</a></span>
  
  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">6.9k</span>
   
</div>

 <!-- 新增访客统计代码 -->
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="busuanzi-count">
    <span class="site-uv">
      <i class="fa fa-user"></i>
      访问用户： <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> 人
    </span>
    <span class="site-uv">
      <i class="fa fa-eye"></i>
      访问次数： <span class="busuanzi-value" id="busuanzi_value_site_pv"></span> 次
    </span>
</div>
<!-- 新增访客统计代码 END-->


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: true,
        appId: 'QfjFwXdw2gqfNp64UEmk0uua-9Nh9j0Va',
        appKey: 'D3ghijIYaGpNiojSL455B9cC',
        placeholder: 'Whisper for you in comment space,thanks buddy!',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"left","width":80,"height":300,"hOffset":20,"vOffset":-200},"mobile":{"show":true},"log":false,"tagMode":false});</script></body>
</html>
